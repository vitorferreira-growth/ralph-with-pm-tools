# CRM InfinitePay - Progress Log

## Completed Tasks

### Step 1.1: Initialize Next.js project (2025-01-14)
- Created Next.js 14 project with App Router
- Configured TypeScript with strict mode
- Configured Tailwind CSS with PostCSS
- Configured ESLint with @typescript-eslint/recommended rules:
  - @typescript-eslint/no-explicit-any: error
  - @typescript-eslint/explicit-function-return-type: warn
  - prefer-const: error
- Added Prettier with tailwindcss plugin
- Configured .prettierrc as per PRD:
  - semi: false
  - singleQuote: true
  - tabWidth: 2
  - trailingComma: es5
  - printWidth: 100
- Added npm scripts: lint, lint:fix, format, format:check
- Verified: npm run dev starts without errors
- Verified: npm run build compiles successfully
- Commit: 8675712

### Step 1.2: Configure shadcn/ui with InfinitePay theme (2025-01-14)
- Initialized shadcn/ui with new-york style and Lucide icons
- Created components.json configuration
- Configured InfinitePay color palette in globals.css:
  - Primary: #6E08F2 (purple) with hover and light variants
  - Accent: #33D9B2 (teal) with light variant
  - Full gray scale (50-900)
  - Functional colors: success, warning, error, info
  - Chart colors for dashboard visualizations
- Extended tailwind.config.ts with PRD Design System:
  - Typography scale (h1-h4, body, body-sm, caption)
  - Spacing system (xs, sm, md, lg, xl, 2xl, 3xl)
  - Border radius tokens (sm, md, lg, xl, 2xl)
  - Box shadows (card, card-hover, kanban, kanban-drag)
  - Transition durations (micro, standard, emphasis, drag)
  - Font families (Inter, JetBrains Mono)
  - Layout tokens (max-width container, sidebar width)
- Added essential shadcn/ui components: button, card, input
- Customized button component with InfinitePay styling:
  - Primary variant uses purple with hover state
  - Outline variant uses primary border
  - Ghost variant uses secondary colors
- Verified: npm run build compiles successfully
- Verified: npm run lint passes (only warnings)

### Step 1.3: Configure Supabase (2025-01-14)
- Installed @supabase/supabase-js and @supabase/ssr packages
- Created src/lib/supabase/ directory structure:
  - client.ts: Browser client using createBrowserClient
  - server.ts: Server client using createServerClient with cookies
  - middleware.ts: Session update helper for middleware
- Created src/types/database.ts with TypeScript types matching PRD schema:
  - tenants, users, sellers, customers, products, opportunities, opportunity_products
  - Types ready for Supabase CLI generation after schema creation
- Created .env.example template with required variables:
  - NEXT_PUBLIC_SUPABASE_URL
  - NEXT_PUBLIC_SUPABASE_ANON_KEY
  - SUPABASE_SERVICE_ROLE_KEY
  - NEXT_PUBLIC_APP_URL
- Created .env.local for local development (gitignored)
- Verified: npm run build compiles successfully
- Verified: npm run lint passes (only warnings)
- User Instructions: Create Supabase project and update .env.local with real keys

### Step 1.4: Create database schema (2025-01-14)
- Created supabase/migrations/001_initial_schema.sql with complete schema
- Tables created:
  - tenants: Multi-tenant support with name, slug
  - users: Linked to auth.users with tenant_id, role (owner/admin/member)
  - sellers: Sales team members with name, email
  - customers: Client data with full contact info, linked to seller
  - products: Product catalog with name, code, price
  - opportunities: CRM pipeline with stages (first_contact through closed_won/lost)
  - opportunity_products: Many-to-many junction table with quantity, unit_price
- Indexes created for:
  - Tenant lookups (all tables)
  - Foreign key relationships
  - Search fields (name, email, code)
  - Stage filtering and date filtering for dashboard
- Functions implemented:
  - get_user_tenant_id(): Returns current user's tenant for RLS
  - update_updated_at_column(): Auto-updates timestamps
  - calculate_opportunity_total(): Auto-calculates opportunity value from products
- Triggers for:
  - Auto-updating updated_at on all tables
  - Auto-calculating opportunity total when products change
- RLS Policies (all tables):
  - SELECT, INSERT, UPDATE, DELETE restricted to user's own tenant
  - Special policies for signup flow (tenant/user creation)
- Verified: npm run build compiles successfully
- Verified: npm run lint passes (only warnings)
- User Instructions: Run migration in Supabase SQL Editor or via CLI

### Step 1.5: Generate Supabase types (2025-01-14)
- Created comprehensive TypeScript types in src/types/database.ts
- Added enum types:
  - UserRole: 'owner' | 'admin' | 'member'
  - OpportunityStage: all 6 CRM stages
- Added Portuguese label mappings for UI:
  - OPPORTUNITY_STAGE_LABELS: Maps stage to Portuguese text
  - OPPORTUNITY_STAGES_ORDER: Ordered array for kanban
- Added Database interface with all tables:
  - Row, Insert, Update types for each table
  - Relationships metadata for foreign keys
  - Functions (get_user_tenant_id)
  - Enums declaration
- Added helper types for convenience:
  - Tables<T>, TablesInsert<T>, TablesUpdate<T> generic helpers
  - Direct type exports: Tenant, User, Seller, Customer, Product, Opportunity, OpportunityProduct
  - Insert types: TenantInsert, UserInsert, etc.
  - Update types: TenantUpdate, UserUpdate, etc.
- Added extended types for relationships:
  - OpportunityWithRelations: Opportunity with customer, seller, products
  - CustomerWithSeller: Customer with seller data
- Added Portuguese constants as per PRD code style:
  - ETAPAS_CRM: Maps Portuguese names to stage values
  - ROLES_USUARIO: Maps Portuguese names to role values
- Verified: npm run build compiles successfully
- Verified: npm run lint passes (only warnings)

### Step 1.6: Configure folder structure (2026-01-14)
- Created complete folder structure as per PRD architecture
- App routes created:
  - src/app/(auth)/ - Auth route group with layout, login, registro pages
  - src/app/(dashboard)/ - Dashboard route group with layout and all module pages
  - src/app/api/ - API routes for all entities (clientes, produtos, vendedores, oportunidades, dashboard)
- Components structure:
  - src/components/layout/ - Sidebar, Header, NavItems placeholders
  - src/components/ui/ - shadcn components (already exists)
  - src/components/dashboard/, clientes/, produtos/, vendedores/, crm/, auth/ - Empty folders ready
- Library structure:
  - src/lib/supabase/ - Already configured
  - src/lib/validations/ - Placeholder for Zod schemas
- Other folders:
  - src/hooks/ - Placeholder for custom hooks
  - src/contexts/ - Placeholder for React contexts
  - src/styles/ - Placeholder for additional styles
  - src/__tests__/e2e/ - Placeholder for E2E tests
- Updated root page.tsx to redirect to /dashboard
- All pages have placeholder content with references to implementation steps
- API routes return 501 Not Implemented status as placeholders
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only warnings)

### Step 2.1: Configure Supabase Auth middleware (2026-01-14)
- Created src/middleware.ts with authentication route protection
- Protected routes: /dashboard, /clientes, /produtos, /vendedores, /crm
- Auth routes: /login, /registro (redirect to dashboard if already logged in)
- Middleware features:
  - Uses Supabase getUser() to validate JWT tokens (not getSession())
  - Redirects unauthenticated users to /login with redirectTo query param
  - Redirects authenticated users away from auth pages to /dashboard
  - Excludes static files, images, and API routes from middleware
- Updated src/lib/supabase/middleware.ts with explicit return type and documentation
- Verified: npm run build compiles successfully (18 routes + Middleware)
- Verified: npm run lint passes (only warnings)

### Step 2.2: Create login page (2026-01-14)
- Created src/components/auth/formulario-login.tsx:
  - Client component with email/password form
  - Uses Supabase signInWithPassword for authentication
  - Loading state with spinner while authenticating
  - Error handling with Portuguese translations
  - Redirects to dashboard (or redirectTo param) on success
  - Link to registration page
- Updated src/app/(auth)/login/page.tsx:
  - Server component with Card layout
  - InfinitePay branding
  - Passes redirectTo search param to form component
- Added shadcn Label component for form labels
- Verified: npm run build compiles successfully
- Verified: npm run lint passes (only pre-existing warnings)

### Step 2.3: Create registration page (2026-01-14)
- Created src/components/auth/formulario-registro.tsx:
  - Client component with registration form (name, company name, email, password, confirm password)
  - Creates tenant with unique slug (company name + timestamp)
  - Creates auth user via Supabase signUp
  - Creates tenant record in tenants table
  - Creates user record in users table with role 'owner'
  - Password validation (minimum 6 characters, confirmation match)
  - Loading state with spinner while registering
  - Error handling with Portuguese translations
  - Redirects to dashboard on success
  - Link to login page for existing users
- Updated src/app/(auth)/registro/page.tsx:
  - Server component with Card layout matching login page
  - InfinitePay branding
  - Uses FormularioRegistro component
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 2.4: Create multi-tenancy logic (2026-01-14)
- Created src/contexts/tenant-context.tsx:
  - TenantProvider component that wraps dashboard routes
  - TenantContext with tenant, usuario, carregando, erro states
  - Loads user and tenant data from Supabase on mount
  - Listens to auth state changes (SIGNED_IN, TOKEN_REFRESHED, SIGNED_OUT)
  - Provides recarregar function to refresh tenant data
- Created src/hooks/use-tenant.ts:
  - useTenant hook with convenient accessors
  - Returns tenant, usuario, tenantId, carregando, erro, autenticado
  - Permission helpers: ehProprietario, ehAdministrador, ehMembro
  - temPermissao(roleMinima) function with role hierarchy (owner > admin > member)
  - Re-exports TenantProvider for easy imports
- Updated src/app/(dashboard)/layout.tsx:
  - Wrapped dashboard layout with TenantProvider
  - Tenant context now available in all dashboard pages
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 3.1: Create dashboard layout (2026-01-14)
- Created src/components/layout/sidebar.tsx:
  - Fixed sidebar for desktop (hidden on mobile, visible on lg screens)
  - Logo with InfinitePay branding (IP icon + CRM text)
  - Navigation menu with 5 items: Dashboard, Clientes, Produtos, Vendedores, CRM
  - Active state styling (primary-light background, primary text)
  - Hover states with gray background
  - Footer with "Powered by InfinitePay" branding
- Created src/components/layout/header.tsx:
  - Responsive header with mobile menu button (hamburger icon)
  - Tenant name displayed on larger screens
  - Mobile logo shown on small screens
  - User info with avatar (initials), name, and tenant name
  - Logout button with signOut functionality
  - Loading states with skeleton placeholders
- Created src/components/layout/mobile-sidebar.tsx:
  - Mobile-only sidebar with overlay
  - Slide-in animation from left
  - Close button with X icon
  - Same navigation items as desktop sidebar
  - Auto-close on route change
  - Body scroll prevention when open
- Created src/components/layout/nav-items.tsx:
  - Shared navigation items constant (ITENS_NAVEGACAO)
  - Standalone NavItems component for reusability
  - Icons from Lucide: LayoutDashboard, Users, Package, UserCircle, Kanban
- Updated src/app/(dashboard)/layout.tsx:
  - Client component with menu state management
  - Uses Sidebar, Header, and MobileSidebar components
  - TenantProvider wraps all content
  - Flex layout with h-screen for full viewport height
  - Overflow handling for scrollable content area
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 3.2: Create sidebar navigation (2026-01-14)
- Note: This step was already implemented as part of Step 3.1
- Navigation items defined in src/components/layout/nav-items.tsx:
  - ITENS_NAVEGACAO constant with all 5 menu items
  - NavItems component with active state logic
- Both Sidebar and MobileSidebar use ITENS_NAVEGACAO
- Active states: bg-primary-light text-primary for active items
- Hover states: bg-gray-100 for inactive items
- Links functional with usePathname() for active detection
- Verified: All acceptance criteria met (Links funcionais, estado ativo visível)

### Step 4.1: Create vendedores API (2026-01-14)
- Created src/app/api/vendedores/route.ts:
  - GET /api/vendedores: Lists all sellers for tenant (RLS applied)
  - POST /api/vendedores: Creates new seller with validation
    - Required fields: nome (name), email
    - Email format validation
    - Duplicate email check within tenant
- Created src/app/api/vendedores/[id]/route.ts:
  - GET /api/vendedores/:id: Fetches specific seller
  - PUT /api/vendedores/:id: Updates seller with validation
    - Partial updates supported
    - Email uniqueness check (excluding self)
  - DELETE /api/vendedores/:id: Removes seller with safety checks
    - Checks for linked customers before delete
    - Checks for linked opportunities before delete
    - Returns descriptive error if dependencies exist
- All endpoints:
  - Verify authentication via getUser()
  - Use RLS (Row Level Security) for tenant isolation
  - Return Portuguese error messages
  - Handle errors gracefully with appropriate HTTP status codes
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 4.2: Create useVendedores hook (2026-01-14)
- Created src/hooks/use-vendedores.ts with full CRUD state management
- Hook interface (UseVendedoresRetorno):
  - vendedores: Seller[] - list of sellers
  - carregando: boolean - loading state
  - erro: string | null - error message
  - buscarVendedores(): Promise<void> - refresh sellers list
  - criarVendedor(dados): Promise<Seller | null> - create new seller
  - atualizarVendedor(id, dados): Promise<Seller | null> - update seller
  - excluirVendedor(id): Promise<boolean> - delete seller
- Features implemented:
  - Auto-loads sellers on mount using useEffect
  - Maintains alphabetical order after create/update operations
  - Proper error handling with Portuguese error messages
  - Uses fetch API to communicate with /api/vendedores endpoints
  - All functions use useCallback for performance optimization
- VendedorInput type for create/update operations:
  - nome: string (required)
  - email: string (required)
- Verified: npm run build compiles successfully
- Verified: npm run lint passes (only pre-existing warnings)

### Step 4.3: Create vendedores page (2026-01-14)
- Created src/components/vendedores/tabela-vendedores.tsx:
  - Table component displaying list of sellers (Name, Email, Actions)
  - Empty state with icon and CTA when no sellers exist
  - Row hover states with action buttons (edit, delete)
  - Uses shadcn/ui Table components
- Created src/components/vendedores/formulario-vendedor.tsx:
  - Dialog form for creating/editing sellers
  - Fields: nome (required), email (required with validation)
  - Modes: create (new) and edit (existing seller)
  - Form validation with error messages in Portuguese
  - Loading states during save operation
  - Closes automatically on successful save
- Created src/components/vendedores/dialogo-excluir-vendedor.tsx:
  - Confirmation dialog for deleting sellers
  - Shows seller name being deleted
  - Warning icon with destructive styling
  - Loading state during deletion
  - Cancel and confirm buttons
- Updated src/app/(dashboard)/vendedores/page.tsx:
  - Client component with full CRUD functionality
  - Integrates useVendedores hook
  - Loading state with spinner
  - Error state with retry button
  - Operation error display (inline toast style)
  - Header with vendor count and "Add" button
  - All three dialog components integrated
- Added shadcn/ui components:
  - table.tsx: Table component family
  - dialog.tsx: Dialog/modal component family
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 4.4: Create vendedores tests (2026-01-14)
- Installed testing dependencies:
  - vitest: Test runner (v4.0.17)
  - @vitejs/plugin-react: React plugin for Vite
  - jsdom: Browser environment simulation
  - @testing-library/react: React testing utilities
  - @testing-library/jest-dom: Custom matchers for DOM testing
  - @testing-library/user-event: User interaction simulation
- Created vitest.config.ts:
  - Configured jsdom environment
  - Set up path aliases (@/)
  - Configured test file patterns
  - Set up coverage reporters
- Created src/__tests__/setup.ts:
  - Mocked next/navigation (useRouter, usePathname, useSearchParams)
  - Mocked global fetch
  - Added beforeEach to clear mocks
- Created src/hooks/use-vendedores.test.ts (14 tests):
  - buscarVendedores: Initial load, error handling, manual refresh
  - criarVendedor: Creation, alphabetical ordering, error handling
  - atualizarVendedor: Update, alphabetical ordering, error handling
  - excluirVendedor: Deletion, error handling
  - Network error handling for all operations
- Created src/components/vendedores/tabela-vendedores.test.tsx (9 tests):
  - Empty state rendering
  - Table rendering with data
  - Header columns verification
  - Action buttons (edit, delete) click handlers
- Created src/components/vendedores/formulario-vendedor.test.tsx (19 tests):
  - Dialog rendering states (open/closed)
  - Create vs edit mode UI differences
  - Form field pre-filling in edit mode
  - Validation (required name, required email)
  - Form submission with data normalization (trim, lowercase email)
  - Dialog close on success, stay open on failure
  - Cancel button behavior
  - Loading state disabling
- Created src/components/vendedores/dialogo-excluir-vendedor.test.tsx (11 tests):
  - Dialog rendering with vendedor data
  - Null vendedor handling
  - Cancel and confirm button handlers
  - Loading state (excluindo) button states
- Added npm scripts:
  - test: vitest (watch mode)
  - test:run: vitest run (single run)
  - test:coverage: vitest run --coverage
- Test results: 53 tests passing
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 5.1: Create products API (2026-01-14)
- Created src/app/api/produtos/route.ts:
  - GET /api/produtos: Lists all products for tenant (RLS applied)
  - POST /api/produtos: Creates new product with validation
    - Required fields: nome (name), valor (price)
    - Optional fields: codigo (code)
    - Value validation (must be number, non-negative)
    - Duplicate code check within tenant (if code provided)
- Created src/app/api/produtos/[id]/route.ts:
  - GET /api/produtos/:id: Fetches specific product
  - PUT /api/produtos/:id: Updates product with validation
    - Partial updates supported
    - Code uniqueness check (excluding self)
    - Code can be null/empty to remove
    - Value must be non-negative number
  - DELETE /api/produtos/:id: Removes product with safety checks
    - Checks for linked opportunity_products before delete
    - Returns descriptive error if dependencies exist
- All endpoints:
  - Verify authentication via getUser()
  - Use RLS (Row Level Security) for tenant isolation
  - Return Portuguese error messages
  - Handle errors gracefully with appropriate HTTP status codes
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)
- Verified: npm run test:run passes (53 tests)

### Step 5.2: Create useProdutos hook (2026-01-14)
- Created src/hooks/use-produtos.ts with full CRUD state management
- Hook interface (UseProdutosRetorno):
  - produtos: Product[] - list of products
  - carregando: boolean - loading state
  - erro: string | null - error message
  - buscarProdutos(): Promise<void> - refresh products list
  - criarProduto(dados): Promise<Product | null> - create new product
  - atualizarProduto(id, dados): Promise<Product | null> - update product
  - excluirProduto(id): Promise<boolean> - delete product
- Features implemented:
  - Auto-loads products on mount using useEffect
  - Maintains alphabetical order after create/update operations
  - Proper error handling with Portuguese error messages
  - Uses fetch API to communicate with /api/produtos endpoints
  - All functions use useCallback for performance optimization
- ProdutoInput type for create/update operations:
  - nome: string (required)
  - codigo?: string | null (optional)
  - valor: number (required)
- Created src/hooks/use-produtos.test.ts with 17 tests:
  - buscarProdutos: Initial load, error handling, manual refresh
  - criarProduto: Creation, without code, alphabetical ordering, error handling
  - atualizarProduto: Update, alphabetical ordering, error handling
  - excluirProduto: Deletion, error handling
  - Network error handling for all operations
- Test results: 70 tests passing (53 previous + 17 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 5.3: Create produtos page (2026-01-14)
- Created src/components/produtos/tabela-produtos.tsx:
  - Table component displaying list of products (Código, Nome, Valor, Ações)
  - Empty state with Package icon and CTA when no products exist
  - Row hover states with action buttons (edit, delete)
  - Currency formatting using Intl.NumberFormat (pt-BR, BRL)
  - Monospace font for code and value columns
- Created src/components/produtos/formulario-produto.tsx:
  - Dialog form for creating/editing products
  - Fields: nome (required), codigo (optional), valor (required with validation)
  - Value input with comma support for Brazilian currency format
  - Modes: create (new) and edit (existing product)
  - Form validation with error messages in Portuguese
  - Loading states during save operation
  - Closes automatically on successful save
- Created src/components/produtos/dialogo-excluir-produto.tsx:
  - Confirmation dialog for deleting products
  - Shows product name being deleted
  - Warning icon with destructive styling
  - Loading state during deletion
  - Cancel and confirm buttons
- Updated src/app/(dashboard)/produtos/page.tsx:
  - Client component with full CRUD functionality
  - Integrates useProdutos hook
  - Loading state with spinner
  - Error state with retry button
  - Operation error display (inline toast style)
  - Header with product count and "Add" button
  - All three dialog components integrated
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)
- Verified: npm run test:run passes (70 tests)

### Step 5.4: Create produtos component tests (2026-01-14)
- Created src/components/produtos/tabela-produtos.test.tsx (11 tests):
  - Empty state rendering (message and no table)
  - Table rendering with headers (Código, Nome, Valor, Ações)
  - Product data display (names, codes, formatted prices in R$)
  - Dash display for products without code
  - Action buttons (edit, delete) per product
  - Callback handlers for onEditar and onExcluir
- Created src/components/produtos/formulario-produto.test.tsx (25 tests):
  - Dialog rendering states (open/closed)
  - Create vs edit mode UI differences (title, button text)
  - Form field pre-filling in edit mode (including value formatting)
  - Field handling for products without code
  - Validation (required name, required value, invalid value, negative value)
  - Multiple validation errors display
  - Zero value acceptance
  - Form submission with data normalization (trim, null for empty code)
  - Decimal separator handling (comma and dot)
  - Dialog close on success, stay open on failure
  - Cancel button behavior
  - Field reset on dialog reopen
  - Loading state disabling
- Created src/components/produtos/dialogo-excluir-produto.test.tsx (11 tests):
  - Dialog rendering with produto data
  - Null produto handling
  - Title and warning message display
  - Product name in confirmation message
  - Cancel and confirm button handlers
  - Loading state (excluindo) button states
- Test results: 117 tests passing (70 previous + 47 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 6.1: Create clientes API (2026-01-14)
- Created src/app/api/clientes/route.ts:
  - GET /api/clientes: Lists all customers for tenant (RLS applied)
    - Includes seller data via join
    - Search by name or email via `busca` query param
    - Filter by seller via `vendedor_id` query param
  - POST /api/clientes: Creates new customer with validation
    - Required fields: nome (name), email
    - Optional fields: whatsapp, endereco, cidade, estado, cep, dataNascimento, vendedorId
    - Email format validation
    - Duplicate email check within tenant
    - CEP validation (8 digits)
    - Date validation for birth_date
    - Seller existence verification if vendedorId provided
- Created src/app/api/clientes/[id]/route.ts:
  - GET /api/clientes/:id: Fetches specific customer with seller data
  - PUT /api/clientes/:id: Updates customer with validation
    - Partial updates supported
    - Email uniqueness check (excluding self)
    - All optional fields can be set to null to remove
    - Seller existence verification if changing vendedorId
  - DELETE /api/clientes/:id: Removes customer with safety checks
    - Checks for linked opportunities before delete
    - Returns descriptive error if dependencies exist
- All endpoints:
  - Verify authentication via getUser()
  - Use RLS (Row Level Security) for tenant isolation
  - Return Portuguese error messages
  - Handle errors gracefully with appropriate HTTP status codes
  - Include seller relationship data in responses
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (117 tests)

### Step 6.2: Create useClientes hook (2026-01-14)
- Created src/hooks/use-clientes.ts with full CRUD state management
- Hook interface (UseClientesRetorno):
  - clientes: CustomerWithSeller[] - list of customers with seller data
  - carregando: boolean - loading state
  - erro: string | null - error message
  - buscarClientes(filtros?): Promise<void> - fetch customers with optional filters
  - criarCliente(dados): Promise<CustomerWithSeller | null> - create new customer
  - atualizarCliente(id, dados): Promise<CustomerWithSeller | null> - update customer
  - excluirCliente(id): Promise<boolean> - delete customer
- FiltrosClientes interface for search functionality:
  - busca?: string - search by name or email
  - vendedorId?: string - filter by seller
- ClienteInput type for create/update operations:
  - nome: string (required)
  - email: string (required)
  - whatsapp, endereco, cidade, estado, cep, dataNascimento, vendedorId (optional)
- Features implemented:
  - Auto-loads customers on mount using useEffect
  - Maintains alphabetical order after create/update operations
  - Proper error handling with Portuguese error messages
  - Search and filter support via query params
  - Uses fetch API to communicate with /api/clientes endpoints
  - All functions use useCallback for performance optimization
- Created src/hooks/use-clientes.test.ts with 21 tests:
  - buscarClientes: Initial load, error handling, manual refresh, search filters, seller filter, multiple filters, empty search handling
  - criarCliente: Creation, minimal fields, alphabetical ordering, error handling
  - atualizarCliente: Update, alphabetical ordering, error handling
  - excluirCliente: Deletion, error handling
  - Network error handling for all operations
- Test results: 138 tests passing (117 previous + 21 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (only pre-existing warnings)

### Step 6.3: Create Zod validation schemas for cliente (2026-01-14)
- Installed zod package for runtime validation
- Created src/lib/validations/cliente.ts with comprehensive validation:
  - clienteSchema: Main validation schema for customer form
    - nome: Required, min 2 chars, max 255, auto-trim
    - email: Required, valid format, auto-lowercase, auto-trim
    - whatsapp: Optional, Brazilian format validation with regex
    - endereco: Optional, max 500 chars
    - cidade: Optional, max 100 chars
    - estado: Optional, 2-char state code, auto-uppercase
    - cep: Optional, 8-digit Brazilian CEP format, auto-format
    - dataNascimento: Optional, valid date, not future, not before 1900
    - vendedorId: Optional, valid UUID, empty string converts to null
  - clienteUpdateSchema: Partial schema for updates (all fields optional)
  - Type exports: ClienteFormData, ClienteUpdateFormData
- Added utility validation functions:
  - validarEmail(email): Checks if email format is valid
  - validarCEP(cep): Checks if CEP format is valid
  - validarWhatsApp(whatsapp): Checks if WhatsApp format is valid
- Added formatting utility functions:
  - formatarCEP(cep): Formats CEP for display (00000-000)
  - formatarWhatsApp(whatsapp): Formats phone for display ((11) 99999-9999)
- Added ESTADOS_BRASILEIROS constant with all 27 Brazilian states
- Created src/lib/validations/cliente.test.ts with 51 tests:
  - nome field: Valid input, trim, required, min length
  - email field: Valid input, lowercase, required, format validation
  - whatsapp field: Various formats, empty, null, invalid
  - cep field: With/without hyphen, empty, null, invalid formats
  - dataNascimento field: Valid, empty, null, future date, ancient date
  - vendedorId field: Valid UUID, null, empty string, invalid
  - Optional fields: endereco, cidade, estado with transforms
  - Update schema: Partial validation
  - Utility functions: Email, CEP, WhatsApp validation and formatting
- Test results: 189 tests passing (138 previous + 51 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 6.4: Create clientes page (2026-01-15)
- Created src/components/clientes/tabela-clientes.tsx:
  - Table component displaying list of customers (Nome, Email, WhatsApp, Cidade, Vendedor, Ações)
  - Empty state with Users icon and CTA when no customers exist
  - Row hover states with action buttons (edit, delete)
  - WhatsApp formatting using formatarWhatsApp utility
  - City/State display with proper formatting
  - Seller name display from relationship
- Created src/components/clientes/formulario-cliente.tsx:
  - Dialog form for creating/editing customers
  - All fields from PRD: nome*, email*, whatsapp, endereco, cidade, estado, cep, dataNascimento, vendedorId
  - Uses Zod validation schema from cliente.ts
  - State dropdown with all 27 Brazilian states
  - Seller dropdown populated from useVendedores hook
  - Form validation with Portuguese error messages
  - Loading states during save operation
  - CEP and WhatsApp formatting on display
- Created src/components/clientes/dialogo-excluir-cliente.tsx:
  - Confirmation dialog for deleting customers
  - Shows customer name being deleted
  - Warning icon with destructive styling
  - Loading state during deletion
  - Cancel and confirm buttons
- Updated src/app/(dashboard)/clientes/page.tsx:
  - Client component with full CRUD functionality
  - Integrates useClientes and useVendedores hooks
  - Search bar with Search icon for filtering by name or email
  - Loading state with spinner
  - Error state with retry button
  - Operation error display (inline toast style)
  - Header with customer count and "Add" button
  - All three dialog components integrated
- Added shadcn/ui Select component for dropdowns
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (189 tests)

### Step 6.5: Create clientes component tests (2026-01-15)
- Created src/components/clientes/tabela-clientes.test.tsx (13 tests):
  - Empty state rendering (message and no table)
  - Table rendering with headers (Nome, Email, WhatsApp, Cidade, Vendedor, Ações)
  - Customer data display (names, emails, formatted WhatsApp)
  - WhatsApp formatting (11999999999 -> (11) 99999-9999)
  - Dash display for null values
  - City/state formatting (city/state, city only, state only)
  - Seller name display from relationship
  - Action buttons (edit, delete) per customer
  - Callback handlers for onEditar and onExcluir
- Created src/components/clientes/formulario-cliente.test.tsx (23 tests):
  - Dialog rendering states (open/closed)
  - Create vs edit mode UI differences (title, button text)
  - Form field display (all 9 fields: nome, email, whatsapp, endereco, cidade, estado, cep, dataNascimento, vendedorId)
  - Form field pre-filling in edit mode (including formatted WhatsApp, CEP)
  - Field handling for customers without optional fields
  - Validation (required name, required email, invalid CEP format)
  - Multiple validation errors display
  - Form submission with data normalization (trim, lowercase email, CEP digits only)
  - Optional fields sent as null when empty
  - Dialog close on success, stay open on failure
  - Cancel button behavior
  - Field reset on dialog reopen
  - Loading state disabling fields and buttons
- Created src/components/clientes/dialogo-excluir-cliente.test.tsx (10 tests):
  - Null cliente handling (returns null)
  - Dialog rendering with cliente data
  - Title and warning message display
  - Customer name in confirmation message
  - Cancel and confirm button handlers
  - Loading state (excluindo) button states
- Fixed FormularioCliente component:
  - Changed SelectItem value="" to value="__none__" for "Nenhum" option (Radix UI doesn't allow empty string values)
  - Updated validation and submit handlers to treat "__none__" as null
- Test results: 235 tests passing (189 previous + 46 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 7.1: Create opportunities API (2026-01-15)
- Created src/app/api/oportunidades/route.ts:
  - GET /api/oportunidades: Lists all opportunities for tenant (RLS applied)
    - Includes customer, seller, and products data via joins
    - Filter by seller via `vendedor_id` query param
    - Filter by stage via `etapa` query param
    - Filter by customer via `cliente_id` query param
  - POST /api/oportunidades: Creates new opportunity with validation
    - Required fields: clienteId (customer)
    - Optional fields: vendedorId, etapa (stage), observacoes (notes), produtos (products array)
    - Each product has: produtoId, quantidade (default 1), precoUnitario
    - Auto-calculates total_value from products
    - Validates customer, seller, and products existence
    - Returns complete opportunity with all relationships
- Created src/app/api/oportunidades/[id]/route.ts:
  - GET /api/oportunidades/:id: Fetches specific opportunity with relationships
  - PUT /api/oportunidades/:id: Full update of opportunity
    - Supports updating customer, seller, stage, notes, and products
    - Replaces products (deletes old, inserts new)
    - Auto-recalculates total_value
    - Sets closed_at when stage is closed_won or closed_lost
  - PATCH /api/oportunidades/:id: Updates only the stage (for kanban drag & drop)
    - Validates stage value
    - Sets/clears closed_at based on stage
    - Efficient endpoint for kanban operations
  - DELETE /api/oportunidades/:id: Removes opportunity
    - Deletes associated opportunity_products first
    - Then deletes the opportunity
- All endpoints:
  - Verify authentication via getUser()
  - Use RLS (Row Level Security) for tenant isolation
  - Return Portuguese error messages
  - Handle errors gracefully with appropriate HTTP status codes
  - Include full relationships data in responses (customer, seller, products)
- Test results: 235 tests passing (no new tests added - API tests will be in Step 7.7)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 7.2: Create useOportunidades hook (2026-01-15)
- Created src/hooks/use-oportunidades.ts with full CRUD state management
- Hook interface (UseOportunidadesRetorno):
  - oportunidades: OpportunityWithRelations[] - list of opportunities with relations
  - carregando: boolean - loading state
  - erro: string | null - error message
  - buscarOportunidades(filtros?): Promise<void> - fetch opportunities with optional filters
  - criarOportunidade(dados): Promise<OpportunityWithRelations | null> - create new opportunity
  - atualizarOportunidade(id, dados): Promise<OpportunityWithRelations | null> - update opportunity
  - moverOportunidade(id, novaEtapa): Promise<OpportunityWithRelations | null> - drag & drop stage update via PATCH
  - excluirOportunidade(id): Promise<boolean> - delete opportunity
  - oportunidadesPorEtapa: Record<OpportunityStage, OpportunityWithRelations[]> - grouped by stage
  - totaisPorEtapa: Record<OpportunityStage, number> - total values per stage
- FiltrosOportunidades interface for filtering:
  - vendedorId?: string - filter by seller
  - etapa?: OpportunityStage - filter by stage
  - clienteId?: string - filter by customer
- OportunidadeInput type for create operations:
  - clienteId: string (required)
  - vendedorId, etapa, observacoes, produtos (optional)
- OportunidadeUpdateInput type for update operations (all optional)
- ProdutoOportunidadeInput type for products:
  - produtoId: string, quantidade?: number, precoUnitario: number
- Features implemented:
  - Auto-loads opportunities on mount using useEffect
  - Optimistic update with rollback for drag & drop (moverOportunidade)
  - Computed values: oportunidadesPorEtapa, totaisPorEtapa for Kanban display
  - Proper error handling with Portuguese error messages
  - Uses fetch API to communicate with /api/oportunidades endpoints
  - All functions use useCallback for performance optimization
- Created src/hooks/use-oportunidades.test.ts with 26 tests:
  - buscarOportunidades: Initial load, error handling, manual refresh, filters (vendedor, etapa, cliente), multiple filters
  - criarOportunidade: Creation, minimal fields, error handling
  - atualizarOportunidade: Update, error handling
  - moverOportunidade: Stage update, optimistic update, rollback on error, closed_won handling
  - excluirOportunidade: Deletion, error handling
  - oportunidadesPorEtapa: Grouping, empty arrays for all stages
  - totaisPorEtapa: Calculations, zeros when empty, multiple opportunities sum
  - Network error handling for all operations
- Test results: 261 tests passing (235 previous + 26 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 7.3: Create KanbanBoard component (2026-01-15)
- Installed @hello-pangea/dnd (maintained fork of react-beautiful-dnd) for drag-and-drop
- Created src/components/crm/kanban-coluna.tsx:
  - KanbanColuna component for individual columns
  - Header with stage indicator (colored dot), label, and card count
  - Total value display in Brazilian currency format (R$)
  - Droppable area for drag-and-drop operations
  - Visual feedback when dragging over column (highlighted background)
  - Empty state for columns with no cards
  - CardOportunidadeSimplificado: Simplified card component within column
    - Displays customer name, total value (monospace font), seller name
    - Product count indicator
    - Click handler for card selection
    - Keyboard accessibility (Enter/Space to click)
    - Hover shadow effect for interaction feedback
  - Color-coded stages: blue (1º Contato), purple (Proposta), yellow (Negociação), orange (Aguardando Pagamento), green (Venda Finalizada), red (Desistiu)
- Created src/components/crm/kanban-board.tsx:
  - KanbanBoard component wrapping DragDropContext
  - Renders 6 columns in order: first_contact → proposal → negotiation → awaiting_payment → closed_won → closed_lost
  - Handles drag end events with validation
  - Only triggers onMoverOportunidade when column changes
  - Loading state with spinner
  - Horizontal scroll for overflow
  - Props: oportunidadesPorEtapa, totaisPorEtapa, onMoverOportunidade, onCardClick, carregando
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (261 tests)

### Step 7.4: Create CardOportunidade component (2026-01-15)
- Created src/components/crm/card-oportunidade.tsx with two card variants:
  - CardOportunidadeCompacto: Simplified card for list views
    - Displays customer name, total value (formatted BRL), stage badge
    - Shows seller name, product count, and relative date
    - Click and keyboard accessibility (Enter/Space)
    - Hover shadow effect for interaction feedback
  - CardOportunidadeCompleto: Full card for detail views
    - Customer name and email in header
    - Stage badge with color coding
    - Total value prominently displayed with label
    - Seller section with avatar placeholder and name
    - Products list with name, code, unit price, quantity
    - Notes section when available
    - Creation and closed dates at footer
  - BadgeEtapa component for reusable stage badges
    - Color-coded by stage (blue, purple, yellow, orange, green, red)
    - Portuguese labels from OPPORTUNITY_STAGE_LABELS
  - Main CardOportunidade component with compact prop switch
  - Helper functions: formatarMoeda, formatarData, formatarDataRelativa
  - Exports: CardOportunidade, BadgeEtapa, CardOportunidadeCompacto, CardOportunidadeCompleto
- Created src/components/crm/card-oportunidade.test.tsx with 42 tests:
  - BadgeEtapa: All 6 stage labels tested
  - CardOportunidadeCompacto: Customer name, value, badge, seller, products count, click handlers
  - CardOportunidadeCompleto: Full details display including products list, notes, dates
  - CardOportunidade: Compact/full mode switching and onClick propagation
- Test results: 303 tests passing (261 previous + 42 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 7.5: Create FormularioOportunidade component (2026-01-15)
- Installed additional shadcn/ui components:
  - sheet.tsx: Sidebar overlay component for form
  - textarea.tsx: Multi-line text input for notes
- Created src/components/crm/formulario-oportunidade.tsx:
  - Sheet-based sidebar form for creating/editing opportunities
  - Fields implemented:
    - Cliente (select with customer name + email display)
    - Vendedor responsável (select with "Nenhum" option)
    - Etapa (select with all 6 CRM stages from OPPORTUNITY_STAGES_ORDER)
    - Produtos (multi-select with add/remove functionality)
    - Observações (textarea for notes)
  - Product management features:
    - Add product from available products dropdown
    - Remove product with trash icon button
    - Edit quantity per product
    - Edit unit price per product (supports comma decimal separator)
    - Auto-calculated subtotals per product
    - Auto-calculated total value
    - Empty state when no products selected
  - Form validation:
    - Required: cliente, at least one product
    - Etapa defaults to 'first_contact' for new opportunities
    - Vendedor and observações are optional
  - Loading states:
    - Disables all fields during save
    - Shows "Salvando..." spinner on submit button
    - Supports external carregando prop
  - Edit mode:
    - Pre-fills all fields from oportunidade data
    - Maps products from opportunity_products with product details
    - Shows "Editar Oportunidade" title and "Salvar" button
  - Create mode:
    - Empty form with placeholders
    - Shows "Nova Oportunidade" title and "Criar Oportunidade" button
  - Proper data handling:
    - Converts empty vendedorId to null
    - Trims observações and converts empty to null
    - Formats products array for API
- Created src/components/crm/formulario-oportunidade.test.tsx with 24 tests:
  - Rendering: Dialog states (open/closed), create vs edit titles
  - Form fields: All 5 fields displayed correctly
  - Edit mode pre-filling: Notes, products with codes, total value
  - Validation: Shows errors for incomplete form
  - Product management: Empty state, display products, remove product, update quantity
  - Form submission: Correct data sent, dialog close on success, stay open on failure
  - Cancel button: Calls onFechar
  - Loading state: Buttons disabled, fields disabled
  - Form reset: Clears fields when reopening
- Updated src/__tests__/setup.ts:
  - Added Element.prototype.hasPointerCapture mock for Radix UI
  - Added Element.prototype.setPointerCapture mock
  - Added Element.prototype.releasePointerCapture mock
  - Added Element.prototype.scrollIntoView mock
- Test results: 327 tests passing (303 previous + 24 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 7.6: Create CRM page (2026-01-15)
- Created src/app/(dashboard)/crm/page.tsx with full kanban integration:
  - Integrates useOportunidades, useClientes, useProdutos, useVendedores hooks
  - Header with CRM title, opportunity count, and controls
  - Filter by seller functionality (dropdown with all sellers)
  - "Nova Oportunidade" button to create new opportunities
  - KanbanBoard component integration with drag-and-drop
  - FormularioOportunidade sheet for create/edit operations
  - Opportunity details sheet with full card view
  - Delete opportunity from details view
  - Confirmation dialog for "Desistiu" (closed_lost) stage
  - Error handling with inline error display
  - Loading state with spinner
  - Error state with retry button
- Features implemented per PRD acceptance criteria:
  - Kanban with 6 columns (drag and drop functional)
  - Card with client, value, products, seller
  - Total value displayed in each column
  - New opportunity creation (sidebar)
  - Edit existing opportunity
  - Filter by seller
  - Multi-select products in opportunity form
- Added shadcn/ui alert-dialog component for confirmations
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run lint passes (no errors)
- Note: Some pre-existing test timeouts in dialog component tests (not related to CRM page)

### Step 7.7: Create CRM tests (2026-01-15)
- Created src/components/crm/kanban-coluna.test.tsx (22 tests):
  - Stage label rendering for all 6 stages
  - Opportunity count badge display
  - Total value formatting in BRL (Brazilian Real)
  - Empty state rendering ("Arraste oportunidades para cá")
  - Opportunity card rendering (customer name, value, seller, product count)
  - Click handler callbacks with correct opportunity data
  - Multiple opportunities in same column
  - Keyboard navigation (Enter, Space)
- Created src/components/crm/kanban-board.test.tsx (18 tests):
  - Loading state with spinner
  - All 6 columns rendered in correct order
  - Opportunities placed in correct columns
  - Total values per column
  - Opportunity count badges
  - Empty state handling for all columns
  - Multiple opportunities per column
  - Cards without seller rendering
  - Cards without products rendering
  - Default non-loading state
- Test infrastructure:
  - DndWrapper helper for drag-drop context in tests
  - Reused criarOportunidadeMock helper from existing tests
  - Fixed multiple button role conflict in keyboard tests
- Verified: npm run test:run passes (361 tests, +40 new)
- Verified: npm run build compiles successfully (18 routes)
- Note: E2E tests (fluxo-kanban.spec.ts) to be added in Section 9 when Playwright is configured

### Step 8.1: Create Dashboard API (2026-01-15)
- Created src/app/api/dashboard/kpis/route.ts:
  - GET /api/dashboard/kpis: Returns KPIs for tenant
  - KPIs: Total Vendas (R$ e qtd), Ticket Médio, Em Negociação (R$ e qtd), Desistências (R$ e qtd)
  - Filter by period via `periodo` query param (mes, trimestre, ano)
  - Period filtering based on created_at for opportunities
  - Calculates ticket médio (average sale value)
  - Groups opportunities by stage (closed_won, in progress, closed_lost)
  - RLS applied via Supabase for tenant isolation
  - Exported DashboardKPIs type interface
- Created src/app/api/dashboard/graficos/route.ts:
  - GET /api/dashboard/graficos: Returns chart data for tenant
  - VendasPorMes: Monthly sales (last N months, default 12)
  - VendasPorVendedor: Sales by seller with totals and quantities
  - VendasPorProduto: Sales by product with totals and quantities
  - ValorPorEtapa: Value per CRM stage (funnel data)
  - Filter by period via `periodo` query param (mes, trimestre, ano)
  - Filter by months via `meses` query param (default 12)
  - Joins with sellers and products for complete data
  - Portuguese month formatting (Jan, Fev, Mar, etc.)
  - Sorted results by value (descending) for sellers and products
  - Exported type interfaces: VendasPorMes, VendasPorVendedor, VendasPorProduto, ValorPorEtapa, DashboardGraficos
- All endpoints:
  - Verify authentication via getUser()
  - Use RLS (Row Level Security) for tenant isolation
  - Return Portuguese error messages
  - Handle errors gracefully with appropriate HTTP status codes
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (361 tests - no new tests, API tests in Step 8.7)

### Step 8.2: Create calculation functions (2026-01-15)
- Created src/lib/calculos.ts with pure, testable calculation functions
- Types implemented:
  - OportunidadeCalculo: Simplified opportunity type for calculations
  - OportunidadeComVendedor: Opportunity with seller data
  - OportunidadeComProdutos: Opportunity with products data
  - ResultadoKPIs: KPI calculation results
  - VendasAgrupadas: Grouped sales results
  - ValorEtapa: Value per stage results
- Constants:
  - ETAPAS_EM_NEGOCIACAO: Active pipeline stages (first_contact, proposal, negotiation, awaiting_payment)
  - ETAPAS_FUNIL: All funnel stages in order
  - NOMES_MESES: Portuguese month names (Jan, Fev, Mar, etc.)
- KPI calculation functions:
  - calcularTicketMedio(vendas): Average sale value
  - calcularTotalVendas(vendas): Sum of sales values
  - filtrarPorEtapas(oportunidades, etapas): Filter opportunities by stages
  - calcularKPIs(oportunidades): Calculate all dashboard KPIs
- Grouping functions:
  - agruparVendasPorVendedor(oportunidades): Group sales by seller
  - agruparVendasPorProduto(oportunidades): Group sales by product
  - calcularValorPorEtapa(oportunidades): Calculate value per CRM stage
  - agruparVendasPorMes(oportunidades, meses): Group sales by month (chronological)
- Date/month functions:
  - formatarMesAno(data): Format date as "Mês/Ano" (e.g., "Jan/2025")
  - gerarListaMeses(quantidade, referencia): Generate list of months
- Formatting functions:
  - formatarMoeda(valor): Format as BRL currency (R$ 1.234,56)
  - formatarPorcentagem(valor, casas): Format as percentage
- Rate calculation functions:
  - calcularTaxaConversao(vendas, total): Conversion rate
  - calcularTaxaDesistencia(desistencias, fechadas): Loss rate
- Created src/lib/calculos.test.ts with 62 comprehensive tests:
  - calcularTicketMedio: 5 tests (zero, single, multiple, decimals, zeros)
  - calcularTotalVendas: 4 tests (zero, single, multiple, decimals)
  - filtrarPorEtapas: 4 tests (single, multiple, no match, empty)
  - calcularKPIs: 3 tests (empty, varied data, zero values)
  - agruparVendasPorVendedor: 4 tests (empty, grouping, no seller, non-closed)
  - agruparVendasPorProduto: 4 tests (empty, grouping, non-closed, empty products)
  - calcularValorPorEtapa: 3 tests (empty, correct values, order)
  - formatarMesAno: 3 tests (January, December, all months)
  - gerarListaMeses: 4 tests (count, chronological, year boundary, 12 months)
  - agruparVendasPorMes: 6 tests (empty, grouping, order, outside period, non-closed, no closed_at)
  - formatarMoeda: 5 tests (integer, decimal, zero, negative, large)
  - formatarPorcentagem: 5 tests (basic, zero, 100%, decimals, >100%)
  - calcularTaxaConversao: 4 tests (zero, basic, 100%, 0%)
  - calcularTaxaDesistencia: 4 tests (zero, basic, 100%, 0%)
  - Constants: 4 tests (active stages, funnel order)
- Test results: 423 tests passing (361 previous + 62 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 8.3: Create useDashboard hook (2026-01-15)
- Created src/hooks/use-dashboard.ts with full dashboard state management
- Hook interface (UseDashboardRetorno):
  - kpis: DashboardKPIs | null - KPI data from API
  - graficos: DashboardGraficos | null - charts data from API
  - carregando: boolean - overall loading state
  - carregandoKpis: boolean - KPIs loading state
  - carregandoGraficos: boolean - charts loading state
  - erro: string | null - error message
  - periodo: PeriodoDashboard - current filter ('mes' | 'trimestre' | 'ano')
  - setPeriodo(periodo): void - change period and refresh data
  - buscarDados(filtros?): Promise<void> - fetch all data in parallel
  - buscarKpis(filtros?): Promise<void> - fetch KPIs only
  - buscarGraficos(filtros?): Promise<void> - fetch charts only
- Features implemented:
  - Auto-loads both KPIs and charts on mount using useEffect
  - Parallel fetching of KPIs and graficos for performance
  - Separate loading states for granular UI feedback
  - Period filter support (mes, trimestre, ano)
  - Optional meses filter for chart historical depth
  - Default period is 'mes'
  - setPeriodo automatically triggers data refresh
  - Empty KPIs fallback when API returns null
  - Proper error handling with Portuguese error messages
  - Uses fetch API to communicate with /api/dashboard endpoints
  - All functions use useCallback for performance optimization
- Created src/hooks/use-dashboard.test.ts with 16 tests:
  - carregamento inicial: Load on mount, default period
  - buscarKpis: Period filter, error handling, empty fallback
  - buscarGraficos: Period filter, meses filter, error handling
  - buscarDados: Parallel fetching, reload capability
  - setPeriodo: Period change and data refresh
  - estados de carregamento: Separate loading states for KPIs and graficos
  - erros de rede: Network error handling for all operations
- Test results: 439 tests passing (423 previous + 16 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 8.4: Create KPI components (2026-01-15)
- Created src/components/dashboard/card-kpi.tsx:
  - CardKPI component for individual KPI display
  - Props: titulo, valor, descricao, icone, variante, carregando, className, onClick
  - Variantes: default (purple), success (green), warning (yellow), error (red)
  - Loading state with CardKPISkeleton component
  - Hover and click interactions with keyboard accessibility (Enter/Space)
  - Monospace font for values (JetBrains Mono)
  - Responsive and accessible design
- Created src/components/dashboard/grid-kpis.tsx:
  - GridKPIs component displays all 4 KPIs in responsive grid
  - Layout: 1 column mobile, 2 columns sm, 4 columns lg
  - KPIs: Total de Vendas, Ticket Médio, Em Negociação, Desistências
  - Icons: DollarSign, TrendingUp, Clock, XCircle from Lucide
  - Portuguese plural/singular handling (1 venda vs 10 vendas)
  - Currency formatting using formatarMoeda from calculos.ts
  - Loading state renders 4 skeleton cards
  - ARIA region with label "Indicadores de desempenho"
  - onKPIClick callback for optional interactivity
  - Exports: CONFIGURACAO_KPIS, ORDEM_KPIS for external use
- Created src/components/dashboard/card-kpi.test.tsx (20 tests):
  - Rendering: Title, value, description, icon
  - Variants: default, success, warning, error color variants
  - Loading state: Skeleton rendering, content hidden
  - Interactivity: onClick, keyboard Enter/Space, cursor-pointer
  - CSS classes: Custom className support
- Created src/components/dashboard/grid-kpis.test.tsx (16 tests):
  - Rendering: All 4 KPIs, BRL formatting, quantity descriptions
  - Singular/plural: "1 venda" vs "10 vendas"
  - Zero values: R$ 0,00 formatting, "0 vendas"
  - Loading state: Skeletons when carregando or kpis null
  - Interactivity: onKPIClick with correct TipoKPI
  - CSS classes: Responsive grid classes
  - Constants: CONFIGURACAO_KPIS and ORDEM_KPIS exports
- Test results: 475 tests passing (439 previous + 36 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 8.5: Create chart components (2026-01-15)
- Installed shadcn/ui chart component with Recharts library
- Created src/components/dashboard/grafico-vendas-mes.tsx:
  - Bar chart showing monthly sales evolution
  - Uses Recharts BarChart with vertical bars
  - ChartContainer with responsive sizing
  - Custom tooltip showing value (R$) and quantity
  - Loading skeleton state (GraficoVendasMesSkeleton)
  - Empty state when no sales data (GraficoVendasMesVazio)
  - Total period value in card description
  - TrendingUp icon from Lucide
- Created src/components/dashboard/grafico-vendas-vendedor.tsx:
  - Horizontal bar chart showing sales by seller
  - Sorted by value (descending)
  - Truncates long seller names (>15 chars)
  - Shows total sales and seller count
  - Custom tooltip with full name, value, quantity
  - Limits display to 10 sellers
  - Loading and empty states
  - Users icon from Lucide
- Created src/components/dashboard/grafico-vendas-produto.tsx:
  - Pie/donut chart showing product distribution
  - Interactive active shape on hover
  - Shows product name and value in center on hover
  - Groups products beyond 5th into "Outros" category
  - 6 color palette cycling (primary, chart-2 to chart-5, accent)
  - Custom tooltip with product name, value, units
  - Loading and empty states
  - Package icon from Lucide
- Created src/components/dashboard/grafico-funil.tsx:
  - Bar chart showing value per CRM stage (funnel)
  - Color-coded bars matching kanban column colors:
    - blue (1º Contato), purple (Proposta), yellow (Negociação)
    - orange (Aguardando Pagamento), green (Venda Finalizada), red (Desistiu)
  - X-axis with angled labels for long stage names
  - Shows "Em negociação" total (excludes closed_won/closed_lost)
  - Custom tooltip with stage label, value, opportunity count
  - Loading and empty states
  - Filter icon from Lucide
- Created test files with comprehensive coverage:
  - grafico-vendas-mes.test.tsx (10 tests): rendering, loading, empty state, data handling
  - grafico-vendas-vendedor.test.tsx (10 tests): rendering, singular/plural, truncation, limits
  - grafico-vendas-produto.test.tsx (10 tests): rendering, grouping "Outros", long names
  - grafico-funil.test.tsx (11 tests): rendering, stage calculation, partial data
- Test results: 516 tests passing (475 previous + 41 new)
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (all tests)

### Step 8.6: Create Dashboard Page (2026-01-15)
- Updated src/app/(dashboard)/dashboard/page.tsx:
  - Client component integrating all dashboard components
  - Uses useDashboard hook for state management
  - Header with title and period filter dropdown
  - Period filter options: Este mês, Últimos 3 meses, Este ano
  - Refresh button to manually reload data (with spin animation)
  - Error state with retry button when no data available
  - Inline error display when data exists but refresh fails
  - GridKPIs component displaying 4 KPI cards
  - 2x2 grid layout for charts on desktop (1 column on mobile)
  - All 4 charts integrated:
    - GraficoVendasMes (monthly sales bar chart)
    - GraficoVendasVendedor (sales by seller horizontal bar chart)
    - GraficoVendasProduto (sales by product pie chart)
    - GraficoFunil (sales funnel by CRM stage)
  - Responsive design with proper spacing (space-y-xl)
- Features per PRD acceptance criteria:
  - Dashboard completo com filtro de período ✓
  - KPIs: Total vendas, Ticket médio, Em negociação, Desistências ✓
  - Gráficos: Vendas por mês, por vendedor, por produto, funil ✓
- Verified: npm run build compiles successfully (18 routes)
- Verified: npm run test:run passes (516 tests)

## Next Tasks
- Step 8.7: Criar testes do dashboard
